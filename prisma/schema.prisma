// ─────────────────────────────────────────────────────────────────────────────
// prisma/schema.prisma
// Aurora Backend — Database Schema
// ORM: Prisma | Database: PostgreSQL
// ─────────────────────────────────────────────────────────────────────────────

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────────────────────────────────────
// ENUM
// ─────────────────────────────────────────────────────────────────────────────

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TRADE
  WALLET_CONNECT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  REJECTED
}

enum AuthProvider {
  GOOGLE
  PHANTOM
  METAMASK
  COINBASE
  WALLETCONNECT
}

// ─────────────────────────────────────────────────────────────────────────────
// USER
// ─────────────────────────────────────────────────────────────────────────────

model User {
  id            String       @id @default(cuid())
  email         String?      @unique // nullable — wallet-only user boleh tanpa email
  name          String
  photoUrl      String?
  // OAuth providers
  googleId      String?      @unique
  // Wallet (semua tipe: Phantom, MetaMask, Coinbase, WalletConnect)
  walletAddress String?      @unique // primary wallet (Polygon/EVM address)
  solanaAddress String?      @unique // Phantom Solana address (opsional)
  authProvider  AuthProvider @default(GOOGLE)
  balance       Decimal      @default(0) @db.Decimal(18, 6)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  transactions Transaction[]
  watchlist    Watchlist[]
  positions    UserPosition[]

  @@map("users")
}

// ─────────────────────────────────────────────────────────────────────────────
// TRANSACTION
// ─────────────────────────────────────────────────────────────────────────────

model Transaction {
  id          String            @id @default(cuid())
  userId      String
  type        TransactionType
  amount      Decimal?          @db.Decimal(18, 6)
  description String
  status      TransactionStatus @default(PENDING)
  metadata    Json?
  createdAt   DateTime          @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@map("transactions")
}

// ─────────────────────────────────────────────────────────────────────────────
// EVENT
// ─────────────────────────────────────────────────────────────────────────────

model Event {
  id          String    @id
  slug        String    @unique
  title       String
  description String?
  category    String
  imageUrl    String?
  startDate   DateTime?
  endDate     DateTime?
  active      Boolean   @default(true)
  closed      Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  markets Market[]

  @@map("events")
}

// ─────────────────────────────────────────────────────────────────────────────
// MARKET
// ─────────────────────────────────────────────────────────────────────────────

model Market {
  id              String   @id
  polymarketId    String   @unique
  slug            String   @unique
  question        String
  description     String?
  category        String
  tags            String[]
  outcomes        String[]
  outcomePrices   Json
  tokens          Json
  volume          Decimal  @default(0) @db.Decimal(18, 2)
  volume24h       Decimal  @default(0) @db.Decimal(18, 2)
  liquidity       Decimal  @default(0) @db.Decimal(18, 2)
  spread          Decimal? @db.Decimal(10, 6)
  active          Boolean  @default(true)
  closed          Boolean  @default(false)
  resolved        Boolean  @default(false)
  resolvedOutcome String?

  featured Boolean @default(false)
  isNew    Boolean @default(false)

  startDate    DateTime?
  endDate      DateTime?
  imageUrl     String?
  icon         String?
  eventId      String?
  lastSyncedAt DateTime  @default(now())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  event        Event?         @relation(fields: [eventId], references: [id])
  priceHistory PriceHistory[]
  watchlist    Watchlist[]
  positions    UserPosition[]

  @@index([category])
  @@index([active, closed])
  @@index([volume24h])
  @@index([featured, volume24h])
  @@index([isNew, createdAt])
  // Untuk Ending Soon — endDate yang dekat dengan waktu sekarang
  @@index([endDate, active, closed])
  // Untuk Highest Volume — sort by total volume
  @@index([volume, active, closed])
  @@map("markets")
}

// ─────────────────────────────────────────────────────────────────────────────
// PRICE HISTORY
// ─────────────────────────────────────────────────────────────────────────────

model PriceHistory {
  id        String   @id @default(cuid())
  marketId  String
  tokenId   String
  outcome   String
  price     Decimal  @db.Decimal(10, 6)
  timestamp DateTime

  market Market @relation(fields: [marketId], references: [id], onDelete: Cascade)

  @@unique([marketId, tokenId, timestamp])
  @@index([marketId, timestamp])
  @@map("price_history")
}

// ─────────────────────────────────────────────────────────────────────────────
// WATCHLIST
// ─────────────────────────────────────────────────────────────────────────────

model Watchlist {
  id        String   @id @default(cuid())
  userId    String
  marketId  String
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  market Market @relation(fields: [marketId], references: [id], onDelete: Cascade)

  @@unique([userId, marketId])
  @@map("watchlist")
}

// ─────────────────────────────────────────────────────────────────────────────
// USER POSITION
// ─────────────────────────────────────────────────────────────────────────────

model UserPosition {
  id           String   @id @default(cuid())
  userId       String
  marketId     String
  outcome      String
  shares       Decimal  @db.Decimal(18, 6)
  avgPrice     Decimal  @db.Decimal(10, 6)
  currentPrice Decimal  @default(0) @db.Decimal(10, 6)
  color        String?
  isSimulated  Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  market Market @relation(fields: [marketId], references: [id], onDelete: Cascade)

  @@unique([userId, marketId, outcome])
  @@map("user_positions")
}

// ─────────────────────────────────────────────────────────────────────────────
// SYNC LOG
// ─────────────────────────────────────────────────────────────────────────────

model SyncLog {
  id        String   @id @default(cuid())
  type      String
  status    String
  count     Int      @default(0)
  error     String?
  duration  Int      @default(0)
  createdAt DateTime @default(now())

  @@map("sync_logs")
}
